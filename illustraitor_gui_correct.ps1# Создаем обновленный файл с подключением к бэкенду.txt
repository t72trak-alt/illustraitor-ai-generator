# –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±—ç–∫–µ–Ω–¥—É
$updatedCode = @'
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
$scriptDir = if ($PSScriptRoot) { $PSScriptRoot } else { Get-Location }
$configPath = Join-Path $scriptDir "illustraitor_config.json"

# –î–µ–º–æ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞
$demoImages = @(
    "https://images.unsplash.com/photo-1506744038136-46273834b3fb",
    "https://images.unsplash.com/photo-1519681393784-d120267933ba", 
    "https://images.unsplash.com/photo-1506905925346-21bda4d32df4",
    "https://images.unsplash.com/photo-1518837695005-2083093ee35b",
    "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05"
)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
$global:lastImageUrl = $null
$global:lastImageSource = ""
$global:openAIKey = ""
$global:unsplashKey = ""

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã
$form = New-Object System.Windows.Forms.Form
$form.Text = "üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π AI"
$form.Size = New-Object System.Drawing.Size(850, 750)
$form.StartPosition = "CenterScreen"
$form.BackColor = [System.Drawing.Color]::FromArgb(30, 30, 40)
$form.FormBorderStyle = [System.Windows.Forms.FormBorderStyle]::FixedDialog
$form.MaximizeBox = $false

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
$labelTitle = New-Object System.Windows.Forms.Label
$labelTitle.Text = "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π AI"
$labelTitle.ForeColor = [System.Drawing.Color]::FromArgb(0, 200, 255)
$labelTitle.Font = New-Object System.Drawing.Font("Segoe UI", 18, [System.Drawing.FontStyle]::Bold)
$labelTitle.Location = New-Object System.Drawing.Point(20, 15)
$labelTitle.Size = New-Object System.Drawing.Size(800, 40)
$labelTitle.TextAlign = [System.Drawing.ContentAlignment]::MiddleCenter
$form.Controls.Add($labelTitle)

# --- –°–µ–∫—Ü–∏—è API –∫–ª—é—á–µ–π ---
$groupAPI = New-Object System.Windows.Forms.GroupBox
$groupAPI.Text = "API –ö–ª—é—á–∏"
$groupAPI.ForeColor = [System.Drawing.Color]::FromArgb(0, 200, 255)
$groupAPI.Location = New-Object System.Drawing.Point(20, 70)
$groupAPI.Size = New-Object System.Drawing.Size(800, 140)
$groupAPI.BackColor = [System.Drawing.Color]::FromArgb(40, 40, 50)
$form.Controls.Add($groupAPI)

# –ü–æ–ª–µ Unsplash —Å –∫–Ω–æ–ø–∫–æ–π üëÅÔ∏è
$labelUnsplash = New-Object System.Windows.Forms.Label
$labelUnsplash.Text = "Unsplash Access Key:"
$labelUnsplash.ForeColor = [System.Drawing.Color]::FromArgb(180, 180, 180)
$labelUnsplash.Location = New-Object System.Drawing.Point(15, 25)
$labelUnsplash.Size = New-Object System.Drawing.Size(300, 20)
$labelUnsplash.Font = New-Object System.Drawing.Font("Segoe UI", 9)
$groupAPI.Controls.Add($labelUnsplash)

$panelUnsplash = New-Object System.Windows.Forms.Panel
$panelUnsplash.Location = New-Object System.Drawing.Point(15, 45)
$panelUnsplash.Size = New-Object System.Drawing.Size(380, 30)
$panelUnsplash.BackColor = [System.Drawing.Color]::Transparent
$groupAPI.Controls.Add($panelUnsplash)

$textUnsplash = New-Object System.Windows.Forms.TextBox
$textUnsplash.Location = New-Object System.Drawing.Point(0, 0)
$textUnsplash.Size = New-Object System.Drawing.Size(345, 30)
$textUnsplash.BackColor = [System.Drawing.Color]::FromArgb(60, 60, 70)
$textUnsplash.ForeColor = [System.Drawing.Color]::White
$textUnsplash.Font = New-Object System.Drawing.Font("Consolas", 10)
$textUnsplash.PasswordChar = '‚Ä¢'
$panelUnsplash.Controls.Add($textUnsplash)

$btnShowUnsplash = New-Object System.Windows.Forms.Button
$btnShowUnsplash.Text = "üëÅÔ∏è"
$btnShowUnsplash.Location = New-Object System.Drawing.Point(350, 0)
$btnShowUnsplash.Size = New-Object System.Drawing.Size(30, 30)
$btnShowUnsplash.BackColor = [System.Drawing.Color]::FromArgb(80, 80, 90)
$btnShowUnsplash.ForeColor = [System.Drawing.Color]::White
$btnShowUnsplash.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnShowUnsplash.Font = New-Object System.Drawing.Font("Segoe UI", 10)
$panelUnsplash.Controls.Add($btnShowUnsplash)

$labelUnsplashHint = New-Object System.Windows.Forms.Label
$labelUnsplashHint.Text = "–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π Unsplash"
$labelUnsplashHint.ForeColor = [System.Drawing.Color]::FromArgb(150, 150, 150)
$labelUnsplashHint.Location = New-Object System.Drawing.Point(15, 80)
$labelUnsplashHint.Size = New-Object System.Drawing.Size(380, 15)
$labelUnsplashHint.Font = New-Object System.Drawing.Font("Segoe UI", 8)
$groupAPI.Controls.Add($labelUnsplashHint)

# –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Unsplash
$btnSaveUnsplash = New-Object System.Windows.Forms.Button
$btnSaveUnsplash.Text = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
$btnSaveUnsplash.Location = New-Object System.Drawing.Point(15, 100)
$btnSaveUnsplash.Size = New-Object System.Drawing.Size(90, 25)
$btnSaveUnsplash.BackColor = [System.Drawing.Color]::FromArgb(0, 173, 181)
$btnSaveUnsplash.ForeColor = [System.Drawing.Color]::White
$btnSaveUnsplash.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnSaveUnsplash.Font = New-Object System.Drawing.Font("Segoe UI", 9)
$groupAPI.Controls.Add($btnSaveUnsplash)

$btnDeleteUnsplash = New-Object System.Windows.Forms.Button
$btnDeleteUnsplash.Text = "–£–¥–∞–ª–∏—Ç—å"
$btnDeleteUnsplash.Location = New-Object System.Drawing.Point(110, 100)
$btnDeleteUnsplash.Size = New-Object System.Drawing.Size(90, 25)
$btnDeleteUnsplash.BackColor = [System.Drawing.Color]::FromArgb(220, 53, 69)
$btnDeleteUnsplash.ForeColor = [System.Drawing.Color]::White
$btnDeleteUnsplash.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnDeleteUnsplash.Font = New-Object System.Drawing.Font("Segoe UI", 9)
$groupAPI.Controls.Add($btnDeleteUnsplash)

# –ü–æ–ª–µ OpenAI —Å –∫–Ω–æ–ø–∫–æ–π üëÅÔ∏è
$labelOpenAI = New-Object System.Windows.Forms.Label
$labelOpenAI.Text = "OpenAI API Key:"
$labelOpenAI.ForeColor = [System.Drawing.Color]::FromArgb(255, 165, 2)
$labelOpenAI.Location = New-Object System.Drawing.Point(405, 25)
$labelOpenAI.Size = New-Object System.Drawing.Size(300, 20)
$labelOpenAI.Font = New-Object System.Drawing.Font("Segoe UI", 9, [System.Drawing.FontStyle]::Bold)
$groupAPI.Controls.Add($labelOpenAI)

$panelOpenAI = New-Object System.Windows.Forms.Panel
$panelOpenAI.Location = New-Object System.Drawing.Point(405, 45)
$panelOpenAI.Size = New-Object System.Drawing.Size(380, 30)
$panelOpenAI.BackColor = [System.Drawing.Color]::Transparent
$groupAPI.Controls.Add($panelOpenAI)

$textOpenAI = New-Object System.Windows.Forms.TextBox
$textOpenAI.Location = New-Object System.Drawing.Point(0, 0)
$textOpenAI.Size = New-Object System.Drawing.Size(345, 30)
$textOpenAI.BackColor = [System.Drawing.Color]::FromArgb(70, 60, 50)
$textOpenAI.ForeColor = [System.Drawing.Color]::White
$textOpenAI.Font = New-Object System.Drawing.Font("Consolas", 10)
$textOpenAI.PasswordChar = '‚Ä¢'
$panelOpenAI.Controls.Add($textOpenAI)

$btnShowOpenAI = New-Object System.Windows.Forms.Button
$btnShowOpenAI.Text = "üëÅÔ∏è"
$btnShowOpenAI.Location = New-Object System.Drawing.Point(350, 0)
$btnShowOpenAI.Size = New-Object System.Drawing.Size(30, 30)
$btnShowOpenAI.BackColor = [System.Drawing.Color]::FromArgb(90, 70, 60)
$btnShowOpenAI.ForeColor = [System.Drawing.Color]::White
$btnShowOpenAI.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnShowOpenAI.Font = New-Object System.Drawing.Font("Segoe UI", 10)
$panelOpenAI.Controls.Add($btnShowOpenAI)

$labelOpenAIHint = New-Object System.Windows.Forms.Label
$labelOpenAIHint.Text = "–ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ platform.openai.com"
$labelOpenAIHint.ForeColor = [System.Drawing.Color]::FromArgb(200, 150, 100)
$labelOpenAIHint.Location = New-Object System.Drawing.Point(405, 80)
$labelOpenAIHint.Size = New-Object System.Drawing.Size(380, 15)
$labelOpenAIHint.Font = New-Object System.Drawing.Font("Segoe UI", 8)
$groupAPI.Controls.Add($labelOpenAIHint)

# –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è OpenAI
$btnSaveOpenAI = New-Object System.Windows.Forms.Button
$btnSaveOpenAI.Text = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
$btnSaveOpenAI.Location = New-Object System.Drawing.Point(405, 100)
$btnSaveOpenAI.Size = New-Object System.Drawing.Size(90, 25)
$btnSaveOpenAI.BackColor = [System.Drawing.Color]::FromArgb(255, 165, 2)
$btnSaveOpenAI.ForeColor = [System.Drawing.Color]::Black
$btnSaveOpenAI.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnSaveOpenAI.Font = New-Object System.Drawing.Font("Segoe UI", 9)
$groupAPI.Controls.Add($btnSaveOpenAI)

$btnDeleteOpenAI = New-Object System.Windows.Forms.Button
$btnDeleteOpenAI.Text = "–£–¥–∞–ª–∏—Ç—å"
$btnDeleteOpenAI.Location = New-Object System.Drawing.Point(500, 100)
$btnDeleteOpenAI.Size = New-Object System.Drawing.Size(90, 25)
$btnDeleteOpenAI.BackColor = [System.Drawing.Color]::FromArgb(220, 53, 69)
$btnDeleteOpenAI.ForeColor = [System.Drawing.Color]::White
$btnDeleteOpenAI.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnDeleteOpenAI.Font = New-Object System.Drawing.Font("Segoe UI", 9)
$groupAPI.Controls.Add($btnDeleteOpenAI)

# --- –°–µ–∫—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ ---
$groupPrompt = New-Object System.Windows.Forms.GroupBox
$groupPrompt.Text = "–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"
$groupPrompt.ForeColor = [System.Drawing.Color]::FromArgb(160, 230, 100)
$groupPrompt.Location = New-Object System.Drawing.Point(20, 225)
$groupPrompt.Size = New-Object System.Drawing.Size(800, 120)
$groupPrompt.BackColor = [System.Drawing.Color]::FromArgb(45, 50, 40)
$form.Controls.Add($groupPrompt)

$labelPrompt = New-Object System.Windows.Forms.Label
$labelPrompt.Text = "–û–ø–∏—à–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å:"
$labelPrompt.ForeColor = [System.Drawing.Color]::FromArgb(200, 220, 180)
$labelPrompt.Location = New-Object System.Drawing.Point(15, 25)
$labelPrompt.Size = New-Object System.Drawing.Size(400, 20)
$labelPrompt.Font = New-Object System.Drawing.Font("Segoe UI", 9)
$groupPrompt.Controls.Add($labelPrompt)

$textPrompt = New-Object System.Windows.Forms.TextBox
$textPrompt.Multiline = $true
$textPrompt.Location = New-Object System.Drawing.Point(15, 50)
$textPrompt.Size = New-Object System.Drawing.Size(770, 60)
$textPrompt.BackColor = [System.Drawing.Color]::FromArgb(60, 65, 55)
$textPrompt.ForeColor = [System.Drawing.Color]::White
$textPrompt.Font = New-Object System.Drawing.Font("Segoe UI", 10)
$textPrompt.ScrollBars = [System.Windows.Forms.ScrollBars]::Vertical
$groupPrompt.Controls.Add($textPrompt)

# --- –°–µ–∫—Ü–∏—è —Å—Ç–∏–ª–µ–π ---
$groupStyles = New-Object System.Windows.Forms.GroupBox
$groupStyles.Text = "–°—Ç–∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (15 —Å—Ç–∏–ª–µ–π)"
$groupStyles.ForeColor = [System.Drawing.Color]::FromArgb(255, 140, 200)
$groupStyles.Location = New-Object System.Drawing.Point(20, 360)
$groupStyles.Size = New-Object System.Drawing.Size(800, 200)
$groupStyles.BackColor = [System.Drawing.Color]::FromArgb(55, 40, 55)
$form.Controls.Add($groupStyles)

# –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–∏–ª–µ–π
$styles = @(
    "–†–µ–∞–ª–∏–∑–º",
    "–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º",
    "–°—é—Ä—Ä–µ–∞–ª–∏–∑–º",
    "–ê–±—Å—Ç—Ä–∞–∫—Ü–∏–æ–Ω–∏–∑–º",
    "–ü–æ–ø-–∞—Ä—Ç",
    "–ö–∏–±–µ—Ä–ø–∞–Ω–∫",
    "–°—Ç–∏–º–ø–∞–Ω–∫",
    "–§—ç–Ω—Ç–µ–∑–∏",
    "–ê–Ω–∏–º–µ",
    "–ü–∏–∫—Å–µ–ª—å-–∞—Ä—Ç",
    "–ú–∞—Å–ª—è–Ω–∞—è –∂–∏–≤–æ–ø–∏—Å—å",
    "–ê–∫–≤–∞—Ä–µ–ª—å",
    "–ß–µ—Ä–Ω–æ-–±–µ–ª–æ–µ",
    "–í–∏–Ω—Ç–∞–∂",
    "–ú—É–ª—å—Ç—è—à–Ω—ã–π —Å—Ç–∏–ª—å"
)

# –°–æ–∑–¥–∞–µ–º ListBox –¥–ª—è —Å—Ç–∏–ª–µ–π
$listStyles = New-Object System.Windows.Forms.ListBox
$listStyles.Location = New-Object System.Drawing.Point(15, 25)
$listStyles.Size = New-Object System.Drawing.Size(770, 165)
$listStyles.BackColor = [System.Drawing.Color]::FromArgb(70, 55, 70)
$listStyles.ForeColor = [System.Drawing.Color]::White
$listStyles.Font = New-Object System.Drawing.Font("Segoe UI", 10)
$listStyles.SelectionMode = [System.Windows.Forms.SelectionMode]::MultiSimple
$listStyles.BorderStyle = [System.Windows.Forms.BorderStyle]::FixedSingle

# –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ ListBox
foreach ($style in $styles) {
    [void]$listStyles.Items.Add($style)
}

# –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Å—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if ($listStyles.Items.Count -gt 0) {
    $listStyles.SetSelected(0, $true)
}
$groupStyles.Controls.Add($listStyles)

# --- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
$panelControls = New-Object System.Windows.Forms.Panel
$panelControls.Location = New-Object System.Drawing.Point(20, 575)
$panelControls.Size = New-Object System.Drawing.Size(800, 100)
$panelControls.BackColor = [System.Drawing.Color]::Transparent
$form.Controls.Add($panelControls)

# –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
$btnGenerate = New-Object System.Windows.Forms.Button
$btnGenerate.Text = "–ì–µ–Ω–µ—Ä—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
$btnGenerate.Location = New-Object System.Drawing.Point(15, 10)
$btnGenerate.Size = New-Object System.Drawing.Size(380, 50)
$btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(46, 213, 115)
$btnGenerate.ForeColor = [System.Drawing.Color]::White
$btnGenerate.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnGenerate.Font = New-Object System.Drawing.Font("Segoe UI", 12, [System.Drawing.FontStyle]::Bold)
$panelControls.Controls.Add($btnGenerate)

# –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
$btnDownload = New-Object System.Windows.Forms.Button
$btnDownload.Text = "–°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
$btnDownload.Location = New-Object System.Drawing.Point(405, 10)
$btnDownload.Size = New-Object System.Drawing.Size(380, 50)
$btnDownload.BackColor = [System.Drawing.Color]::FromArgb(100, 150, 255)
$btnDownload.ForeColor = [System.Drawing.Color]::White
$btnDownload.FlatStyle = [System.Windows.Forms.FlatStyle]::Flat
$btnDownload.Font = New-Object System.Drawing.Font("Segoe UI", 12, [System.Drawing.FontStyle]::Bold)
$btnDownload.Enabled = $false
$panelControls.Controls.Add($btnDownload)

# --- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π ---
function Update-GenerateButtonState {
    $hasOpenAI = $textOpenAI.Text.Trim() -ne ""
    $hasUnsplash = $textUnsplash.Text.Trim() -ne ""
    
    if (-not $hasOpenAI -and -not $hasUnsplash) {
        $btnGenerate.Text = "üé≤ –î–µ–º–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è"
        $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(155, 89, 182) # –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
    } elseif ($hasOpenAI) {
        $btnGenerate.Text = "üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DALL-E 3"
        $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(46, 213, 115) # –ó–µ–ª–µ–Ω—ã–π
    } else {
        $btnGenerate.Text = "üîç –ü–æ–∏—Å–∫ –≤ Unsplash"
        $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(0, 173, 181) # –ë–∏—Ä—é–∑–æ–≤—ã–π
    }
}

function Save-Key($keyType, $keyValue) {
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
    if ($keyType -eq "OpenAIKey") {
        $global:openAIKey = $keyValue
        # –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        $btnSaveOpenAI.Text = "‚úì"
        $btnSaveOpenAI.BackColor = [System.Drawing.Color]::FromArgb(0, 200, 150)
        Start-Sleep -Milliseconds 500
        $btnSaveOpenAI.Text = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        $btnSaveOpenAI.BackColor = [System.Drawing.Color]::FromArgb(255, 165, 2)
    } else {
        $global:unsplashKey = $keyValue
        # –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        $btnSaveUnsplash.Text = "‚úì"
        $btnSaveUnsplash.BackColor = [System.Drawing.Color]::FromArgb(0, 200, 150)
        Start-Sleep -Milliseconds 500
        $btnSaveUnsplash.Text = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        $btnSaveUnsplash.BackColor = [System.Drawing.Color]::FromArgb(0, 173, 181)
    }
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
    $config = @{}
    if (Test-Path $configPath) {
        $config = Get-Content $configPath -Raw | ConvertFrom-Json -AsHashtable
    }
    
    if ($keyValue -eq "") {
        $config.Remove($keyType)
    } else {
        $config[$keyType] = $keyValue
    }
    
    try {
        $config | ConvertTo-Json | Set-Content $configPath -Force
        Write-Host "–ö–ª—é—á $keyType —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª." -ForegroundColor Green
    } catch {
        Write-Host "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞: $_" -ForegroundColor Red
    }
    
    Update-GenerateButtonState
}

function Remove-Key($keyType) {
    if ($keyType -eq "OpenAIKey") {
        $textOpenAI.Text = ""
        $global:openAIKey = ""
        # –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        $btnDeleteOpenAI.Text = "‚úì"
        $btnDeleteOpenAI.BackColor = [System.Drawing.Color]::FromArgb(180, 40, 56)
        Start-Sleep -Milliseconds 500
        $btnDeleteOpenAI.Text = "–£–¥–∞–ª–∏—Ç—å"
        $btnDeleteOpenAI.BackColor = [System.Drawing.Color]::FromArgb(220, 53, 69)
    } else {
        $textUnsplash.Text = ""
        $global:unsplashKey = ""
        # –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        $btnDeleteUnsplash.Text = "‚úì"
        $btnDeleteUnsplash.BackColor = [System.Drawing.Color]::FromArgb(180, 40, 56)
        Start-Sleep -Milliseconds 500
        $btnDeleteUnsplash.Text = "–£–¥–∞–ª–∏—Ç—å"
        $btnDeleteUnsplash.BackColor = [System.Drawing.Color]::FromArgb(220, 53, 69)
    }
    
    # –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
    if (Test-Path $configPath) {
        try {
            $config = Get-Content $configPath -Raw | ConvertFrom-Json -AsHashtable
            $config.Remove($keyType)
            $config | ConvertTo-Json | Set-Content $configPath -Force
            Write-Host "–ö–ª—é—á $keyType —É–¥–∞–ª–µ–Ω –∏–∑ —Ñ–∞–π–ª–∞." -ForegroundColor Yellow
        } catch {
            Write-Host "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞: $_" -ForegroundColor Red
        }
    }
    
    Update-GenerateButtonState
}

function Load-Config {
    if (Test-Path $configPath) {
        try {
            $config = Get-Content $configPath -Raw | ConvertFrom-Json
            $textOpenAI.Text = if ($config.OpenAIKey) { $config.OpenAIKey } else { "" }
            $textUnsplash.Text = if ($config.UnsplashKey) { $config.UnsplashKey } else { "" }
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ –ø–∞–º—è—Ç—å
            $global:openAIKey = $textOpenAI.Text
            $global:unsplashKey = $textUnsplash.Text
            
            Write-Host "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞." -ForegroundColor Green
        } catch {
            Write-Host "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: $_" -ForegroundColor Red
        }
    } else {
        Write-Host "–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏." -ForegroundColor Yellow
    }
    Update-GenerateButtonState
}

# --- –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ üëÅÔ∏è ---
$unsplashVisible = $false
$openAIVisible = $false

$btnShowUnsplash.Add_Click({
    $script:unsplashVisible = -not $script:unsplashVisible
    if ($script:unsplashVisible) {
        $textUnsplash.PasswordChar = $null
        $btnShowUnsplash.Text = "üîí"
        $btnShowUnsplash.BackColor = [System.Drawing.Color]::FromArgb(0, 173, 181)
    } else {
        $textUnsplash.PasswordChar = '‚Ä¢'
        $btnShowUnsplash.Text = "üëÅÔ∏è"
        $btnShowUnsplash.BackColor = [System.Drawing.Color]::FromArgb(80, 80, 90)
    }
})

$btnShowOpenAI.Add_Click({
    $script:openAIVisible = -not $script:openAIVisible
    if ($script:openAIVisible) {
        $textOpenAI.PasswordChar = $null
        $btnShowOpenAI.Text = "üîí"
        $btnShowOpenAI.BackColor = [System.Drawing.Color]::FromArgb(255, 165, 2)
    } else {
        $textOpenAI.PasswordChar = '‚Ä¢'
        $btnShowOpenAI.Text = "üëÅÔ∏è"
        $btnShowOpenAI.BackColor = [System.Drawing.Color]::FromArgb(90, 70, 60)
    }
})

# --- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞–º–∏ ---
$btnSaveUnsplash.Add_Click({
    $unsplashKey = $textUnsplash.Text.Trim()
    Save-Key "UnsplashKey" $unsplashKey
})

$btnDeleteUnsplash.Add_Click({
    Remove-Key "UnsplashKey"
})

$btnSaveOpenAI.Add_Click({
    $openAIKey = $textOpenAI.Text.Trim()
    Save-Key "OpenAIKey" $openAIKey
})

$btnDeleteOpenAI.Add_Click({
    Remove-Key "OpenAIKey"
})

# --- –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –¥–µ–º–æ-—Ä–µ–∂–∏–º–æ–º ---
$btnGenerate.Add_Click({
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞
    if ($textPrompt.Text.Trim() -eq "") {
        return
    }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
    $hasOpenAI = $textOpenAI.Text.Trim() -ne ""
    $hasUnsplash = $textUnsplash.Text.Trim() -ne ""
    
    if (-not $hasOpenAI -and -not $hasUnsplash) {
        # –î–ï–ú–û-–†–ï–ñ–ò–ú (–Ω–µ—Ç –∫–ª—é—á–µ–π)
        $btnGenerate.Text = "üé≤ –î–µ–º–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è..."
        $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(155, 89, 182) # –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        $btnGenerate.Enabled = $false
        
        Start-Sleep -Seconds 2
        
        # –°–ª—É—á–∞–π–Ω–æ–µ –¥–µ–º–æ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        $randomImage = $demoImages | Get-Random
        $global:lastImageUrl = $randomImage
        $global:lastImageSource = "demo"
        
        $btnGenerate.Text = "üé≤ –î–µ–º–æ –≥–æ—Ç–æ–≤–æ!"
        $btnDownload.Enabled = $true
        
        Start-Sleep -Seconds 1
        $btnGenerate.Text = "–ì–µ–Ω–µ—Ä—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
        $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(46, 213, 115)
        $btnGenerate.Enabled = $true
    } else {
        # –û–±—ã—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–µ—Å—Ç—å –∫–ª—é—á–∏) - –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–≠–ö–ï–ù–î–£
        if ($hasOpenAI) {
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª–µ–π –¥–ª—è DALL-E
            $selectedStyles = $listStyles.SelectedItems
            if ($selectedStyles.Count -eq 0) {
                Write-Host "–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å—Ç–∏–ª—å –¥–ª—è DALL-E 3" -ForegroundColor Yellow
                return
            }
            $btnGenerate.Text = "üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DALL-E 3..."
            $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(36, 163, 95) # –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
        } else {
            $btnGenerate.Text = "üîç –ü–æ–∏—Å–∫ –≤ Unsplash..."
            $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(0, 143, 161) # –¢–µ–º–Ω–æ-–±–∏—Ä—é–∑–æ–≤—ã–π
        }
        
        $btnGenerate.Enabled = $false
        
        try {
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –±—ç–∫–µ–Ω–¥—É
            $body = @{
                prompt = $textPrompt.Text.Trim()
                api_type = if ($hasOpenAI) { "openai" } else { "unsplash" }
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è OpenAI
            if ($hasOpenAI) {
                $selectedStyles = @($listStyles.SelectedItems)
                if ($selectedStyles.Count -gt 0) {
                    $body.styles = $selectedStyles
                }
            }
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –±—ç–∫–µ–Ω–¥—É
            $apiUrl = "http://localhost:8000/generate"
            $jsonBody = $body | ConvertTo-Json
            
            Write-Host "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API..." -ForegroundColor Cyan
            
            $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Body $jsonBody -ContentType "application/json" -TimeoutSec 30
            
            if ($response.status -eq "success") {
                $global:lastImageUrl = $response.url
                $global:lastImageSource = $response.source
                $btnDownload.Enabled = $true
                $btnGenerate.Text = if ($hasOpenAI) { "‚úÖ –ì–æ—Ç–æ–≤–æ (DALL-E)" } else { "‚úÖ –ù–∞–π–¥–µ–Ω–æ (Unsplash)" }
                Write-Host "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!" -ForegroundColor Green
                Write-Host "URL: $($response.url)" -ForegroundColor Cyan
            } else {
                $btnGenerate.Text = "‚ùå –û—à–∏–±–∫–∞"
                $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(220, 53, 69)
                Write-Host "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: $($response.message)" -ForegroundColor Red
                Start-Sleep -Seconds 2
            }
            
        } catch {
            $btnGenerate.Text = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏"
            $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(220, 53, 69)
            Write-Host "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: $_" -ForegroundColor Red
            Start-Sleep -Seconds 2
        }
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        $btnGenerate.Text = "–ì–µ–Ω–µ—Ä—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
        $btnGenerate.BackColor = [System.Drawing.Color]::FromArgb(46, 213, 115)
        $btnGenerate.Enabled = $true
    }
})

# --- –õ–æ–≥–∏–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ---
$btnDownload.Add_Click({
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è URL
    if (-not $global:lastImageUrl) {
        Write-Host "–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è" -ForegroundColor Red
        return
    }
    
    # –ü—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å Unsplash
    try {
        Write-Host "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å: $global:lastImageUrl" -ForegroundColor Cyan
        
        $saveDialog = New-Object System.Windows.Forms.SaveFileDialog
        $saveDialog.Filter = "PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (*.png)|*.png|JPEG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (*.jpg)|*.jpg|–í—Å–µ —Ñ–∞–π–ª—ã (*.*)|*.*"
        
        if ($global:lastImageSource -eq "demo") {
            $saveDialog.FileName = "demo_$(Get-Date -Format 'yyyyMMdd_HHmmss').jpg"
        } else {
            $saveDialog.FileName = "generated_$(Get-Date -Format 'yyyyMMdd_HHmmss').jpg"
        }
        
        $saveDialog.InitialDirectory = [Environment]::GetFolderPath('Desktop')
        
        if ($saveDialog.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
            # –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            $webClient = New-Object System.Net.WebClient
            $webClient.DownloadFile($global:lastImageUrl, $saveDialog.FileName)
            $webClient.Dispose()
            
            Write-Host "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: $($saveDialog.FileName)" -ForegroundColor Green
        }
        
    } catch {
        Write-Host "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: $_" -ForegroundColor Yellow
        
        # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - —Å–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω
        $saveDialog = New-Object System.Windows.Forms.SaveFileDialog
        $saveDialog.Filter = "PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (*.png)|*.png|JPEG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (*.jpg)|*.jpg|–í—Å–µ —Ñ–∞–π–ª—ã (*.*)|*.*"
        
        if ($global:lastImageSource -eq "demo") {
            $saveDialog.FileName = "demo_$(Get-Date -Format 'yyyyMMdd_HHmmss').png"
        } else {
            $saveDialog.FileName = "generated_$(Get-Date -Format 'yyyyMMdd_HHmmss').png"
        }
        
        $saveDialog.InitialDirectory = [Environment]::GetFolderPath('Desktop')
        
        if ($saveDialog.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
            $bitmap = New-Object System.Drawing.Bitmap(400, 400)
            $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
            
            # –†–∞–∑–Ω—ã–π —Ñ–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            if ($global:lastImageSource -eq "demo") {
                $graphics.Clear([System.Drawing.Color]::FromArgb(155, 89, 182)) # –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
                $sourceText = "–î–µ–º–æ-—Ä–µ–∂–∏–º"
            } elseif ($global:lastImageSource -eq "dalle") {
                $graphics.Clear([System.Drawing.Color]::FromArgb(46, 213, 115)) # –ó–µ–ª–µ–Ω—ã–π
                $sourceText = "DALL-E 3"
            } else {
                $graphics.Clear([System.Drawing.Color]::FromArgb(0, 173, 181)) # –ë–∏—Ä—é–∑–æ–≤—ã–π
                $sourceText = "Unsplash"
            }
            
            $font = New-Object System.Drawing.Font("Arial", 16, [System.Drawing.FontStyle]::Bold)
            $brush = New-Object System.Drawing.SolidBrush([System.Drawing.Color]::White)
            $promptText = $textPrompt.Text.Substring(0, [Math]::Min(30, $textPrompt.Text.Length))
            if ($textPrompt.Text.Length -gt 30) { $promptText += "..." }
            
            $graphics.DrawString("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: $promptText", $font, $brush, 20, 180)
            $fontSmall = New-Object System.Drawing.Font("Arial", 12)
            $graphics.DrawString("–ò—Å—Ç–æ—á–Ω–∏–∫: $sourceText", $fontSmall, $brush, 20, 220)
            
            if ($global:lastImageSource -eq "demo") {
                $fontSmallest = New-Object System.Drawing.Font("Arial", 10)
                $graphics.DrawString("–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á–∏", $fontSmallest, $brush, 20, 250)
            }
            
            $graphics.Dispose()
            $bitmap.Save($saveDialog.FileName)
            $bitmap.Dispose()
            
            Write-Host "–°–æ–∑–¥–∞–Ω–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" -ForegroundColor Yellow
        }
    }
})

# –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
Load-Config

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
[void]$form.ShowDialog()
'@

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
$updatedCode | Out-File -FilePath "illustraitor_gui_correct.ps1" -Encoding UTF8 -Force

Write-Host "GUI –æ–±–Ω–æ–≤–ª–µ–Ω —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±—ç–∫–µ–Ω–¥—É!" -ForegroundColor Green